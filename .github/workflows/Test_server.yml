name: Auto_Build_React_on_Main

on:
  push:
    branches:
      - main

jobs:
  build-and-restart:
    runs-on: self-hosted
    env:
      CI: true

    steps:
      - name: Navigate to project directory
        shell: cmd
        run: |
          echo Changing directory to E:\react ...
          cd /d E:\react

      - name: Install dependencies
        shell: cmd
        run: |
          echo Running npm install ...
          cd /d E:\react
          npm install

      - name: Build project (without touching web.config or server.js)
        shell: cmd
        run: |
          echo Starting build process ...
          cd /d E:\react
          npm run build
          echo âœ… Build completed successfully.

      - name: Ensure PM2 Daemon is running and restart Nextserver
        shell: cmd
        run: |
          echo Checking PM2 Daemon ...
          set PM2_HOME=%USERPROFILE%\.pm2
          set PATH=%PATH%;%USERPROFILE%\AppData\Roaming\npm

          echo Checking if PM2 Daemon is alive ...
          "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" ping || (
            echo PM2 Daemon not running, starting it ...
            "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" resurrect || (
              echo Resurrect failed, starting new PM2 daemon ...
              "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" start "E:\react\server.js" --name Nextserver
            )
          )

          echo Restarting PM2 service: Nextserver ...
          "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" restart NextServer || echo PM2 restart failed, continuing...

          echo Saving PM2 process list ...
          "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" save

          echo Current PM2 list:
          "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" list
