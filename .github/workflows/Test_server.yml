name: Test_server
on:
  push:
    branches:
      - main

jobs:
  build-and-restart:
    runs-on: self-hosted
    env:
      CI: true

    steps:
      # 1️⃣ تغییر مسیر به پوشه اصلی سرویس
      - name: Navigate to E:\store
        shell: cmd
        run: |
          cd /d E:\store

      # 2️⃣ بررسی package.json و نصب وابستگی‌ها
      - name: Install dependencies
        shell: cmd
        run: |
          cd /d E:\store
          if not exist package.json (
            echo ❌ package.json not found in E:\store
            exit /b 1
          )
          echo 📦 Installing dependencies...
          npm install

      # 3️⃣ بیلد پروژه
      - name: Build project
        shell: cmd
        run: |
          cd /d E:\store
          npm run build
          echo ✅ Build completed.

      # 4️⃣ ری‌استارت مقاوم و نمایش تغییر شمارنده
      - name: Restart NextServer and verify count
        shell: cmd
        run: |
          rem مسیر PM2 برای کاربر اصلی runner
          set PM2_HOME=C:\Users\14040678\.pm2
          set PATH=%PATH%;C:\Users\14040678\AppData\Roaming\npm

          echo ---- BEFORE RESTART ----
          pm2 describe NextServer | find "status"
          pm2 describe NextServer | find "uptime"
          pm2 describe NextServer | find "restarts"

          echo Forcing reload...
          pm2 reload NextServer || (
            echo Process not found or reload failed. Deleting and starting fresh...
            pm2 delete NextServer || echo No process to delete.
            pm2 start "E:\store\server.js" --name NextServer
          )

          timeout /T 3 >nul

          echo ---- AFTER RESTART ----
          pm2 describe NextServer | find "status"
          pm2 describe NextServer | find "uptime"
          pm2 describe NextServer | find "restarts"

          echo Saving PM2 state...
          pm2 save

          echo ---- CURRENT PM2 LIST ----
          pm2 list
