name: Test_server
on:
  push:
    branches:
      - main

jobs:
  build-and-restart:
    runs-on: self-hosted
    env:
      CI: true

    steps:
      - name: Navigate to project directory
        shell: cmd
        run: |
          echo Changing directory to E:\react ...
          cd /d E:\react

      - name: Install dependencies
        shell: cmd
        run: |
          echo Running npm install ...
          cd /d E:\react
          npm install

      - name: Build project (without touching web.config or server.js)
        shell: cmd
        run: |
          echo Starting build process ...
          cd /d E:\react
          npm run build
          echo âœ… Build completed successfully.

      - name: Restart PM2 Nextserver
        shell: cmd
        run: |
          echo Restarting PM2 service: Nextserver ...
          "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" restart Nextserver || echo PM2 restart failed, continuing...
          "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" save
          "%USERPROFILE%\AppData\Roaming\npm\pm2.cmd" list
