name: Test_server
on:
  push:
    branches:
      - main

jobs:
  build-and-restart:
    runs-on: self-hosted
    env:
      CI: true

    steps:
      # 1ï¸âƒ£ ØªØºÛŒÛŒØ± Ù…Ø³ÛŒØ± Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ Ø§ØµÙ„ÛŒ Ø³Ø±ÙˆÛŒØ³
      - name: Navigate to E:\store
        shell: cmd
        run: |
          cd /d E:\store

      # 2ï¸âƒ£ Ø¨Ø±Ø±Ø³ÛŒ package.json Ùˆ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      - name: Install dependencies
        shell: cmd
        run: |
          cd /d E:\store
          if not exist package.json (
            echo âŒ package.json not found in E:\store
            exit /b 1
          )
          echo ðŸ“¦ Installing dependencies...
          npm install

      # 3ï¸âƒ£ Ø¨ÛŒÙ„Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡
      - name: Build project
        shell: cmd
        run: |
          cd /d E:\store
          npm run build
          echo âœ… Build completed.

      # 4ï¸âƒ£ Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª Ù…Ù‚Ø§ÙˆÙ… Ùˆ Ù†Ù…Ø§ÛŒØ´ ØªØºÛŒÛŒØ± Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
      - name: Restart NextServer and verify count
        shell: cmd
        run: |
          rem Ù…Ø³ÛŒØ± PM2 Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§ØµÙ„ÛŒ runner
          set PM2_HOME=C:\Users\14040678\.pm2
          set PATH=%PATH%;C:\Users\14040678\AppData\Roaming\npm

          echo ---- BEFORE RESTART ----
          pm2 describe NextServer | find "status"
          pm2 describe NextServer | find "uptime"
          pm2 describe NextServer | find "restarts"

          echo Forcing reload...
          pm2 reload NextServer || (
            echo Process not found or reload failed. Deleting and starting fresh...
            pm2 delete NextServer || echo No process to delete.
            pm2 start "E:\store\server.js" --name NextServer
          )

          timeout /T 3 >nul

          echo ---- AFTER RESTART ----
          pm2 describe NextServer | find "status"
          pm2 describe NextServer | find "uptime"
          pm2 describe NextServer | find "restarts"

          echo Saving PM2 state...
          pm2 save

          echo ---- CURRENT PM2 LIST ----
          pm2 list
